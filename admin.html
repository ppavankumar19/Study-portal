<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin • Study Portal</title>
  <style>
    :root{
      --bg:#020617;
      --bg-soft:rgba(15,23,42,0.7);
      --card:rgba(15,23,42,0.85);
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(148,163,184,0.35);
      --primary:#38bdf8;
      --danger:#f97373;
      --ok:#22c55e;
      --soft:#0b1120;
      --glow:#38bdf8;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #1d4ed8 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #22c55e 0, transparent 55%),
        radial-gradient(circle at 0% 100%, #ec4899 0, transparent 55%),
        #020617;
      min-height:100vh;
      padding:26px;
      color:var(--ink);
      display:flex;
      align-items:stretch;
      justify-content:center;
    }
    .wrap{
      width:100%;
      max-width:1180px;
      display:grid;
      grid-template-columns: minmax(0,1.05fr) minmax(0,1.1fr);
      gap:22px;
    }
    @media(max-width:900px){
      body{ padding:18px; }
      .wrap{ grid-template-columns:1fr; }
    }
    .card{
      position:relative;
      background:linear-gradient(135deg, var(--bg-soft), rgba(15,23,42,0.95));
      border-radius:22px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:
        0 18px 45px rgba(15,23,42,0.75),
        0 0 0 1px rgba(15,23,42,0.6);
      padding:20px 20px 18px;
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      overflow:hidden;
      transform:translateY(0);
      transition:
        transform .25s ease,
        box-shadow .25s ease,
        border-color .25s ease,
        background .25s ease;
    }
    .card::before{
      content:'';
      position:absolute;
      inset:-1px;
      background:radial-gradient(circle at 0 0, rgba(56,189,248,0.16), transparent 55%);
      opacity:0;
      transition:opacity .4s ease;
      pointer-events:none;
    }
    .card:hover{
      transform:translateY(-3px);
      box-shadow:
        0 26px 60px rgba(15,23,42,0.9),
        0 0 0 1px rgba(56,189,248,0.3);
      border-color:rgba(56,189,248,0.5);
      background:linear-gradient(135deg, rgba(15,23,42,0.95), var(--bg-soft));
    }
    .card:hover::before{ opacity:1; }

    h1{
      margin:0 0 6px;
      font-size:18px;
      letter-spacing:.02em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    h1 span.badge{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      color:var(--muted);
    }
    .sub{
      color:var(--muted);
      margin:0 0 14px;
      font-size:13px;
      line-height:1.6;
    }

    label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin:14px 0 6px;
    }
    input[type="text"], textarea, input[type="file"]{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.45);
      padding:10px 12px;
      outline:none;
      background:rgba(15,23,42,0.85);
      color:var(--ink);
      font-size:13px;
      transition:
        border-color .2s ease,
        box-shadow .2s ease,
        background .2s ease,
        transform .08s ease;
    }
    input[type="text"]:focus,
    textarea:focus,
    input[type="file"]:focus{
      border-color:rgba(56,189,248,0.9);
      box-shadow:0 0 0 1px rgba(56,189,248,0.5),0 0 0 10px rgba(56,189,248,0.16);
      background:rgba(15,23,42,0.95);
      transform:translateY(-1px);
    }
    textarea{ min-height:100px; resize:vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:16px;
    }
    .btn{
      border-radius:999px;
      border:1px solid transparent;
      padding:9px 14px;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg,#38bdf8,#0ea5e9);
      color:#0b1120;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 10px 26px rgba(8,47,73,0.75);
      transition:
        transform .16s ease,
        box-shadow .16s ease,
        filter .16s ease,
        border-color .16s ease;
    }
    .btn:hover{
      filter:brightness(1.08);
      transform:translateY(-1px);
      box-shadow:0 16px 32px rgba(8,47,73,0.9);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 8px 18px rgba(8,47,73,0.7);
    }
    .btn.secondary{
      background:rgba(15,23,42,0.9);
      border-color:rgba(148,163,184,0.7);
      color:var(--ink);
      box-shadow:0 10px 24px rgba(15,23,42,0.9);
    }
    .btn.secondary:hover{
      border-color:rgba(56,189,248,0.8);
      box-shadow:0 16px 32px rgba(15,23,42,1);
    }
    .btn.danger{
      background:linear-gradient(135deg,#f97373,#fb7185);
      color:#111827;
      box-shadow:0 10px 26px rgba(127,29,29,0.8);
    }

    .status{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(15,23,42,0.96));
      border:1px dashed rgba(148,163,184,0.55);
      border-radius:14px;
      padding:9px 11px;
      white-space:pre-wrap;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .status::before{
      content:'●';
      font-size:10px;
      color:var(--ok);
      animation:pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%,100%{ opacity:0.5; transform:scale(.95); }
      50%{ opacity:1; transform:scale(1.08); }
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
    }
    th, td{
      text-align:left;
      padding:9px 6px;
      border-bottom:1px solid rgba(15,23,42,0.95);
      font-size:12px;
    }
    thead th{
      color:var(--muted);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:11px;
      padding-bottom:6px;
    }
    tr{
      transition:background .15s ease, transform .15s ease;
    }
    tbody tr:hover{
      background:rgba(15,23,42,0.9);
      transform:translateY(-1px);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding:5px 9px;
      border-radius:999px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(56,189,248,0.45);
      color:var(--ink);
      font-size:11px;
      gap:6px;
    }
    .pill::before{
      content:'⏺';
      font-size:9px;
      color:var(--glow);
    }
    .tiny{ font-size:11px; color:var(--muted); }

    .table-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }
    .table-header span{
      font-size:12px;
      color:var(--muted);
    }

    @media(max-width:600px){
      .card{ border-radius:18px; padding:18px 16px 16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
        <div>
          <h1 id="formTitle">Create lesson <span class="badge">Admin</span></h1>
          <p class="sub">
            Add title, description, tasks, and upload your <b>.m4a/.mp4a</b> audio or <b>.mp4</b> video.
          </p>
        </div>
        <button class="btn secondary" style="padding:6px 10px;font-size:11px;" onclick="logout()">
          Logout
        </button>
      </div>

      <input type="hidden" id="id" />

      <label>Title</label>
      <input type="text" id="title" placeholder="e.g., Prompting Basics" />

      <label>Description</label>
      <textarea id="description" placeholder="What this lesson is about..."></textarea>

      <label>Upload Media (optional)</label>
      <input type="file" id="file" />

      <div class="tiny" style="margin-top:8px;">
        Current media file:
        <span class="pill" id="currentFile">None</span>
      </div>

      <label>Resource Link (optional)</label>
      <input type="text" id="resourceLink" placeholder="https://..." />

      <label>Tasks / Notes</label>
      <textarea id="tasks" placeholder="1) ...
2) ..."></textarea>

      <div class="row">
        <button class="btn" onclick="saveLesson()">Save lesson</button>
        <button class="btn secondary" onclick="resetForm()">New</button>
      </div>

      <div class="status" id="status">Status: ready</div>
    </div>

    <div class="card">
      <div class="table-header">
        <h1>Lessons</h1>
        <span id="countLabel">0 lessons</span>
      </div>
      <p class="sub">Manage lessons. Media uploads are stored under <code>/video</code> and streamed to students.</p>

      <table>
        <thead>
          <tr>
            <th style="width:45%;">Title</th>
            <th style="width:30%;">Media</th>
            <th style="width:25%;">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
  let lessons = [];

  function setStatus(msg){
    document.getElementById('status').textContent = 'Status: ' + msg;
  }

  async function logout(){
    await fetch('/api/admin/logout', { method:'POST' });
    window.location.href = '/admin-login';
  }

  async function loadLessons(){
    const res = await fetch('/api/lessons?ts=' + Date.now());
    lessons = await res.json();
    document.getElementById('countLabel').textContent =
      `${lessons.length} lesson${lessons.length === 1 ? '' : 's'}`;
    renderTable();
  }

  function renderTable(){
    const tbody = document.getElementById('tbody');
    if (!lessons.length){
      tbody.innerHTML =
        `<tr><td colspan="3" class="tiny">No lessons yet. Create one on the left.</td></tr>`;
      return;
    }
    tbody.innerHTML = lessons.map(l => `
      <tr>
        <td><b>${escapeHtml(l.title || '')}</b></td>
        <td>
          ${l.mediaFile
            ? `<span class="pill">${escapeHtml(l.mediaFile)}</span>`
            : `<span class="tiny">No media</span>`}
        </td>
        <td>
          <button class="btn secondary" style="padding:6px 10px;font-size:11px;"
            onclick="editLesson(${l.id})">Edit</button>
          <button class="btn danger" style="padding:6px 10px;font-size:11px;"
            onclick="deleteLesson(${l.id})">Delete</button>
        </td>
      </tr>
    `).join('');
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[c]));
  }

  function resetForm(){
    document.getElementById('id').value = '';
    document.getElementById('title').value = '';
    document.getElementById('description').value = '';
    document.getElementById('resourceLink').value = '';
    document.getElementById('tasks').value = '';
    document.getElementById('file').value = '';
    document.getElementById('currentFile').textContent = 'None';
    document.getElementById('formTitle').textContent = 'Create lesson';
    setStatus('ready');
  }

  function editLesson(id){
    const l = lessons.find(x => x.id == id);
    if (!l) return;

    document.getElementById('id').value = l.id;
    document.getElementById('title').value = l.title || '';
    document.getElementById('description').value = l.description || '';
    document.getElementById('resourceLink').value = l.resourceLink || '';
    document.getElementById('tasks').value = l.tasks || '';
    document.getElementById('file').value = '';
    document.getElementById('currentFile').textContent = l.mediaFile || 'None';
    document.getElementById('formTitle').textContent = 'Edit lesson';
    setStatus('editing lesson #' + l.id);
  }

  async function deleteLesson(id){
    if (!confirm('Delete this lesson?')) return;
    await fetch('/api/lessons/' + id, { method: 'DELETE' });
    setStatus('deleted lesson #' + id);
    await loadLessons();
    resetForm();
  }

  async function uploadIfSelected(){
    const fileInput = document.getElementById('file');
    if (!fileInput.files || !fileInput.files[0]) return null;

    const fd = new FormData();
    fd.append('file', fileInput.files[0]);

    setStatus('uploading file...');
    const res = await fetch('/api/upload', { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Upload failed');

    setStatus('uploaded: ' + data.fileName);
    return data.fileName;
  }

  async function saveLesson(){
    try{
      const id = document.getElementById('id').value
        ? Number(document.getElementById('id').value)
        : null;
      const title = document.getElementById('title').value.trim();
      if (!title){
        setStatus('Title is required');
        return;
      }

      const existing = id
        ? (lessons.find(x => x.id == id)?.mediaFile || '')
        : '';
      const uploadedName = await uploadIfSelected();
      const mediaFile = uploadedName || existing;

      const payload = {
        id,
        title,
        description: document.getElementById('description').value,
        mediaFile,
        resourceLink: document.getElementById('resourceLink').value,
        tasks: document.getElementById('tasks').value
      };

      setStatus('saving lesson...');
      const res = await fetch('/api/lessons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const out = await res.json();
      if (!res.ok) throw new Error(out.error || 'Save failed');

      document.getElementById('currentFile').textContent = out.lesson.mediaFile || 'None';
      setStatus('saved lesson #' + out.lesson.id);

      await loadLessons();
      document.getElementById('id').value = out.lesson.id;
      document.getElementById('formTitle').textContent = 'Edit lesson';
      document.getElementById('file').value = '';
    } catch (e){
      setStatus('error: ' + e.message);
    }
  }

  loadLessons();
</script>
</body>
</html>
